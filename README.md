# patch_server_updater

This script is used to keep a patch definition updated with the last version of an app. It's directly based on brysontyrrell's works (github).

https://github.com/brysontyrrell/Patch-Starter-Script

https://github.com/brysontyrrell/PatchServer

It uses the json file from Patch-Starter-Script to generate a config file during the patch definition push.

After, the config file is used to add a new version for this patch with a manual call or a scripted one.

(Example: we parse a website page everyday to get all existed version for an application and updated our patch server if a new version is announced).

## Points to mention, not related to this script

- The last version pushed to the patch server is the last release of the app.
- Jamf Pro can't make a link between an user version and a patch server version, it will show an unknown version (in the patch management console)

You can upvote this :) :
https://www.jamf.com/jamf-nation/feature-requests/8308/report-real-current-software-version-and-not-unknown-when-version-is-not-referenced-in-the-patch-source

##  Command

### init

- create the config file for add command and push to the patch Server

### add

- push a new app version based on the config file generated by init

##  Usage
```
patch_server_updater.sh init -j [TEMPLATE_FILE] -u [PATCH_SERVER_URL] -o [OUTPUT_FILE_CONFIG]

     -j, json patch definition (generated with patchstarter.py - https://github.com/brysontyrrell/Patch-Starter-Script) [Required]
     -u, url of the patch server (like https://127.0.0.1:5000) [Required]
     -o, output config auto generated file path [Required]
     -t, api token for server with auth

patch_server_updater.sh add -d [DATE] -v [VERSION] -o [OS_MIN] -c [CONFIG_FILE]

      -d, date for the new version, format (YYYY-MM-DD) [Required]
      -v, version name [Required]
      -o, min Mac OS version [Required]
      -c, config file generated by patch_server_updater.sh init [Required]
      -t, api token for server with auth
```

## Example (utilization with a website parsing on a cron to get all the version) :
With the brysontyrrell script :
```
python patchstarter.py /Applications/PhpStorm.app/ -o .
```

We get the json file patch definition for the version installed on the Mac.

```PhpStorm.json```

We manually edit the file to change the values (currentVersion, releaseDate, minimumOperatingSystem) to an old version.
Update all the similar field with this new values. (example with sed)
```
sed -i -e "s/2018.3.5/2016.1 RC1/g" PhpStorm.json
sed -i -e "s/2019-03-12T16:24:07Z/2016-03-10T13:36:00Z/g" PhpStorm.json
sed -i -e "s/10.8/10.6/g" PhpStorm.json
```

Now we use patch_server_updater.sh init to generate the config file and push the definition on the patch server.
```
./patch_server_updater.sh init -j PhpStorm.json -u https://patchserver.example.com/ -o Phpstorm.conf
JSON : PhpStorm.json
URL : https://patchserver.example.com/
CONFIG : Phpstorm.conf
Input JSON checked, seems to obe OK, checking patch server access ...
OK, is recheable, trying to push JSON file to the API.
Push success, Phpstorm.conf will be generate soon
Phpstorm.conf config file generated !
patch_server_updater [add] will be able to update a new version of PhpStorm if you can parse a website or collect informations
```

For the next release, we now can use patch_server_updater.sh add.
```
./patch_server_updater.sh add -d 2016-03-17 -v 2016.1 -o 10.6 -c Phpstorm.conf
DATE : 2016-03-17
VERSION : 2016.1
MIN_OS : 10.6
CONFIG : Phpstorm.conf

Phpstorm.conf imported
New version detected : 2016.1
Pushing to patch server ...
Done
```

Result if the version already exists :
```
Phpstorm.conf imported
Version already on patch server
```

##  Licence MIT
